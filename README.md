# Data Extractor from Waymo Open Dataset and Sample Annotations for use with PIEPredict

This repository holds supplementary codes (kits) and documents for the [Implementation of PIEPredict on Waymo Open Dataset](https://github.com/eyuell/ped-int-tra).

### Table of contents
* [Preparation](#prep)
* [Step 1: Extract Images and Labels](#exe_step1)
* [Step 2A: Generate Pedestrian Annotations](#exe_step2A)
* [Step 2B: Generate Pedestrian Annotations and Identify Pedestrians](#exe_step2B)
* [Step 3: Generate Vehicle Movement information (OBD)](#exe_step3)
* [Additional kit](#ped_area)
* [Sample Annotations](#samples)
* [Corresponding author](#author)
* [License](#license)


<a name="prep"></a>
## Preparation

The executable kits are designated by files which start with number. The numbers show the sequence they might be executed. Especially kit number 2 requires the execution of kit number 1 to have the necessary files. The source and destination folders shall be supplied correctly inside the code. The segments of Waymo Open Dataset (WOD) that end with `.tfrecord` shall be located in an input folder.

<a name="exe_step1"></a>
## Step 1: Extract Labels and Images

In the `1extract_image_label.py` file, the `main_path` can be supplied which could hold the `input/segment` and `output` folders of the kit. Alternatively, the `segments_dir` and `output_dir` paths can be supplied. 

Then the command `python 1extract_image_label.py` can be executed and the images and labels for each segments shall be populated in the `camera/images` and `camera/labels` folders respectively.

<a name="exe_step2A"></a>
## Step 2A: Generate Pedestrian Annotations

The annotation files that will be related with `annotation` and `annotation_attributes` folders of the PIE implementation can be generated by executing the command `python 2fetch_ped_data.py`. The output folder of the `Step 1` will be used as input of this `Step 2`. After reading information from the `camera/labels/` folder, the resulting annotations will be saved in the `annot_files` folder. 

These annotations have pedestrians information that have the pedestrian id, frame numbers, and bounding box informations. The other information is expected to be manually filled by studying each pedestrian in each frame. To get the compiled images together with the id of each pedestrian, `Step 2B` can be used.

<a name="exe_step2B"></a>
## Step 2A: Generate Pedestrian Annotations and Identify Pedestrians

While generating the pedestrian annotations, if there is an interest to compile new images that holds the identification of each pedestrian in each frames, a positive number can be provided at the last part of the command line as `python 2fetch_ped_data.py 1`. Hence, the images will be located in the `compiled_imgs` folder.

<a name="exe_step3"></a>
## Step 3: Generate Vehicle Movement information (OBD)

From the scope of predicting pedestrian trajectory using PIE model, the annotation that is related with annotation_vehicle folder can be generated with the command `python 3waymo_OBD_extractor.py`. The file setup shall be the same as in `Step 1` such that the segment file will be read from `input/segment`and the resulting annotation will be saved in `annot_files` folder.

<a name="ped_area"></a>
## Additional kit

The fourth kit can be used if there is an interest to calculate the area of pedestrian's bounding boxes for each segment. It will display the area for each segment and the summed total. This kit need the location of the `annotations` folder as an input.

<a name="samples"></a>
## Sample Annotations

As a sample annotation, there are six video annotations. The sample annotations are grouped for training, validating and testing using three folders `wod1tr`, `wod2va`, and `wod3te` respectively for each of the annotation types. The images from waymo open dataset shall also be distributed in similar folder names. the sample annotations are [sample_annotation](https://github.com/eyuell/waymo-pie-annotation/tree/main/sample_annotations) folder. The segment names associated with the annotations are listed in [segments_list](segments_list.txt) file.

<a name="author"></a>
## Corresponding author

* **[Eyuell G](https://www.linkedin.com/in/eyuell/)**

<a name="license"></a>
## License
This project is licensed under the Apache 2.0 License - see the [LICENSE](LICENSE) file for details.
